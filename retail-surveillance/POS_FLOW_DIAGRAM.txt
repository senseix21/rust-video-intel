â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    POS INTEGRATION COMPLETE FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TIMELINE VIEW (Real-time event processing)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

14:34:00  â”‚  ğŸ‘¨â€ğŸ’¼ Cashier starts ringing up customer
          â”‚  â””â”€ POS Terminal: Loading items...
          â”‚
14:34:10  â”‚  ğŸ’³ Customer requests discount
          â”‚  â””â”€ Cashier: Applies 50% discount
          â”‚
14:34:15  â”‚  ğŸ“¤ POS PUBLISHES EVENT
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  â”‚ Topic: pos/events/store001/discount    â”‚
          â”‚  â”‚                                        â”‚
          â”‚  â”‚ {                                      â”‚
          â”‚  â”‚   "event_type": "discount_applied",    â”‚
          â”‚  â”‚   "staff_id": "emp_12345",            â”‚
          â”‚  â”‚   "order_id": "ORD48592",             â”‚
          â”‚  â”‚   "discount_percent": 50.0,           â”‚
          â”‚  â”‚   "amount": 150.00                    â”‚
          â”‚  â”‚ }                                      â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚       â”‚
          â”‚       â”‚ MQTT (< 5ms latency)
          â”‚       â–¼
14:34:15  â”‚  ğŸ“¥ SURVEILLANCE RECEIVES
          â”‚  â””â”€ POSIntegration::handle_mqtt_event()
          â”‚      â”œâ”€ Parse JSON âœ“
          â”‚      â”œâ”€ Validate schema âœ“
          â”‚      â””â”€ Extract fields âœ“
          â”‚
14:34:15  â”‚  ğŸ¯ RISK ANALYSIS
          â”‚  â””â”€ RiskAnalyzer::calculate_risk_score()
          â”‚      â”œâ”€ Base risk (discount): 0.2
          â”‚      â”œâ”€ High discount (>30%): +0.3
          â”‚      â”œâ”€ After hours: +0.0
          â”‚      â””â”€ TOTAL: 0.5 (MEDIUM-HIGH)
          â”‚
14:34:15  â”‚  ğŸš¨ ALERT TRIGGERED
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  â”‚ âš ï¸  SUSPICIOUS ACTIVITY DETECTED       â”‚
          â”‚  â”‚                                        â”‚
          â”‚  â”‚ Type: 50% Discount Applied             â”‚
          â”‚  â”‚ Staff: emp_12345                       â”‚
          â”‚  â”‚ Order: ORD48592                        â”‚
          â”‚  â”‚ Risk: 0.50 / 1.00 (MEDIUM-HIGH)       â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
14:34:16  â”‚  ğŸ“¹ VIDEO CORRELATION STARTS
          â”‚  â””â”€ Request clips for: 14:33:15 - 14:35:15
          â”‚      â”œâ”€ Camera: checkout_02 (Register view)
          â”‚      â”œâ”€ Camera: checkout_wide (Floor view)
          â”‚      â””â”€ Camera: entrance (Customer tracking)
          â”‚
14:34:17  â”‚  ğŸ¬ VIDEO PROCESSING
          â”‚  â””â”€ For each camera:
          â”‚      â”œâ”€ Extract 2-minute clip
          â”‚      â”œâ”€ Run people detection
          â”‚      â”œâ”€ Face recognition (emp_12345)
          â”‚      â””â”€ Behavior analysis
          â”‚
14:34:18  â”‚  ğŸ’¾ SAVE EVIDENCE
          â”‚  â”œâ”€ Video clip: /clips/2024-10-04/14-34-15_discount_emp12345.mp4
          â”‚  â”œâ”€ Metadata: Order ORD48592, Ticket T8923
          â”‚  â”œâ”€ Detection results: 2 people (cashier + customer)
          â”‚  â””â”€ Database entry created
          â”‚
14:34:19  â”‚  ğŸ“Š UPDATE METRICS
          â”‚  â””â”€ Dashboard shows:
          â”‚      â”œâ”€ POS Events: 42
          â”‚      â”œâ”€ Alerts: 3
          â”‚      â”œâ”€ Risk Score Avg: 0.35
          â”‚      â””â”€ Videos Linked: 3


SYSTEM ARCHITECTURE VIEW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POS TERMINAL   â”‚  Employee performs action at register
â”‚   (Register 02)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Publishes JSON event
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT BROKER     â”‚  Message routing
â”‚  (Mosquitto)     â”‚  â€¢ Topic: pos/events/store001/discount
â”‚  Port 1883       â”‚  â€¢ QoS: 1 (At least once delivery)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Delivers to subscribers
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SURVEILLANCE SYSTEM                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MQTT Client   â”‚  â”‚ Risk Analyzerâ”‚  â”‚ Video Pipeline  â”‚  â”‚
â”‚  â”‚               â”‚  â”‚              â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ â€¢ Subscribe   â”‚â”€â–¶â”‚ â€¢ Score risk â”‚â”€â–¶â”‚ â€¢ Find cameras â”‚  â”‚
â”‚  â”‚ â€¢ Parse JSON  â”‚  â”‚ â€¢ Check rulesâ”‚  â”‚ â€¢ Extract clipsâ”‚  â”‚
â”‚  â”‚ â€¢ Queue       â”‚  â”‚ â€¢ Generate   â”‚  â”‚ â€¢ Run ML       â”‚  â”‚
â”‚  â”‚               â”‚  â”‚   alerts     â”‚  â”‚ â€¢ Link to eventâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                   â”‚                   â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                             â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 3. Store evidence
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STORAGE LAYER                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL     â”‚  â”‚   S3 / MinIO    â”‚  â”‚   Redis     â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚             â”‚  â”‚
â”‚  â”‚ â€¢ Event records â”‚  â”‚ â€¢ Video clips   â”‚  â”‚ â€¢ Real-time â”‚  â”‚
â”‚  â”‚ â€¢ Staff history â”‚  â”‚ â€¢ Thumbnails    â”‚  â”‚   alerts    â”‚  â”‚
â”‚  â”‚ â€¢ Correlations  â”‚  â”‚ â€¢ Evidence      â”‚  â”‚ â€¢ Cache     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 4. Query & Review
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MANAGEMENT LAYER                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  REST API       â”‚  â”‚   Dashboard     â”‚  â”‚   Alerts    â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚             â”‚  â”‚
â”‚  â”‚ â€¢ Query events  â”‚  â”‚ â€¢ Video viewer  â”‚  â”‚ â€¢ Slack     â”‚  â”‚
â”‚  â”‚ â€¢ Statistics    â”‚  â”‚ â€¢ Staff reports â”‚  â”‚ â€¢ Email     â”‚  â”‚
â”‚  â”‚ â€¢ Export data   â”‚  â”‚ â€¢ Risk trends   â”‚  â”‚ â€¢ SMS       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DATA FLOW BREAKDOWN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Step 1: EVENT GENERATION (POS System)
  Input:  Cashier action at register
  Output: JSON event with order_id, ticket_no, staff_id
  Time:   < 1ms

Step 2: MESSAGE TRANSPORT (MQTT)
  Input:  JSON event
  Output: Delivered message to subscribers
  Time:   2-5ms (local network)

Step 3: EVENT PARSING (Surveillance)
  Input:  Raw MQTT message
  Output: Validated POSEvent struct
  Time:   < 1ms

Step 4: RISK CALCULATION (Risk Analyzer)
  Input:  POSEvent
  Output: Risk score (0.0 - 1.0)
  Time:   < 1ms

Step 5: ALERT DECISION (Alert Engine)
  Input:  Risk score + event type
  Output: Alert trigger decision
  Time:   < 1ms

Step 6: VIDEO CORRELATION (Video Manager)
  Input:  Event timestamp
  Output: List of video clips to extract
  Time:   < 10ms (database query)

Step 7: VIDEO EXTRACTION (Video Pipeline)
  Input:  Camera IDs + time range
  Output: Video clip files
  Time:   1-3 seconds (depends on clip length)

Step 8: EVIDENCE STORAGE (Database)
  Input:  Event + video links + detections
  Output: Permanent record
  Time:   10-20ms

TOTAL END-TO-END LATENCY: ~2-4 seconds
  (From POS action to video evidence linked)


REAL WORLD EXAMPLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Scenario: Employee Discount Fraud

Day 1, 2:34 PM - First Incident
  â”œâ”€ Employee applies 50% discount to friend's purchase
  â”œâ”€ POS publishes discount event
  â”œâ”€ Risk score: 0.5 (medium-high due to large discount)
  â”œâ”€ Alert generated
  â”œâ”€ Video shows employee and customer laughing
  â””â”€ Manager marks for review

Day 1, 4:15 PM - Second Incident
  â”œâ”€ Same employee, different "friend"
  â”œâ”€ Another 50% discount
  â”œâ”€ Risk score: 0.8 (repeat offender pattern detected)
  â”œâ”€ URGENT alert to manager
  â”œâ”€ System links both incidents
  â””â”€ Face recognition shows same customer (disguised)

Day 2, 10:00 AM - Investigation
  â”œâ”€ Manager reviews both video clips
  â”œâ”€ Confirms fraud pattern
  â”œâ”€ Total loss: $890 in unauthorized discounts
  â”œâ”€ Employee terminated
  â””â”€ Police report filed with video evidence

Without this system:
  â”œâ”€ Fraud would continue undetected
  â”œâ”€ Loss could reach $10,000+ before discovery
  â”œâ”€ No video evidence (cameras record, but who watches?)
  â””â”€ Employee would claim "manager approved it"

With this system:
  â”œâ”€ Detected in real-time
  â”œâ”€ Automatic video evidence
  â”œâ”€ Pattern recognition across incidents
  â””â”€ Clear audit trail for prosecution


KEY METRICS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Performance:
  â€¢ Event processing latency:    < 10ms
  â€¢ Alert generation latency:     < 50ms
  â€¢ Video correlation latency:    1-3 seconds
  â€¢ End-to-end latency:           2-4 seconds

Capacity:
  â€¢ Max events per second:        1,000+
  â€¢ Max concurrent cameras:       100
  â€¢ Video retention:              30-90 days
  â€¢ Event retention:              7 years

Accuracy:
  â€¢ False positive rate:          < 5%
  â€¢ Detection accuracy:           > 95%
  â€¢ Risk scoring precision:       > 90%
  â€¢ Video correlation success:    > 98%


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
